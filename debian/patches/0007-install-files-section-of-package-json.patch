From 6e2827d31e34237c1b5edb9274fd1ebc97e227f6 Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Mon, 31 Oct 2016 22:52:11 +0300
Subject: [PATCH 1/2] Install files from directories and files fields

https://docs.npmjs.com/files/package.json#directories
https://docs.npmjs.com/files/package.json#files

Fixes https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=841995
---
 npm2deb/__init__.py | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

Index: npm2deb/npm2deb/__init__.py
===================================================================
--- npm2deb.orig/npm2deb/__init__.py
+++ npm2deb/npm2deb/__init__.py
@@ -238,11 +238,29 @@ and may not include tests.""")
 
     def create_install(self):
         content = ''
-        libs = ['package.json']
+        libs = {'package.json'}
         if _os.path.isdir('bin'):
-            libs.append('bin')
+            libs.add('bin')
         if _os.path.isdir('lib'):
-            libs.append('lib')
+            libs.add('lib')
+
+        # install files from directories field
+        if 'directories' in self.json:
+            directories = self.json['directories']
+            if 'bin' in directories:
+                libs.add(directories['bin'])
+            if 'lib' in directories:
+                libs.add(directories['lib'])
+
+        # install files from files field
+        if 'files' in self.json:
+            files = self.json['files']
+            # npm v1.4 returns string if files field has only one entry
+            if isinstance(files, str):
+                libs.add(files)
+            else:
+                libs = libs.union(files)
+
         # install main if not in a subpath
         if 'main' in self.json:
             main = self.json['main']
@@ -250,12 +268,13 @@ and may not include tests.""")
             if main == 'index':
                 main = 'index.js'
             if not main.find('/') > 0:
-                libs.append(_os.path.normpath(main))
+                libs.add(_os.path.normpath(main))
         else:
             if _os.path.exists('index.js'):
-                libs.append('index.js')
+                libs.add('index.js')
             else:
-                libs.append('*.js')
+                libs.add('*.js')
+
         for filename in libs:
             content += "%s %s/\n" % (filename, self.debian_dest)
         utils.create_debian_file('install', content)
